# RealTimeDataMonitorDemo 运行指南（多进程+Redis大厂风格）

## 0. 一键启动（推荐）

项目已新增 `docker-compose.yml`，同时定义了两项服务：

* `redis` ‑ 官方 `redis:7-alpine` 镜像
* `realtime-demo` ‑ gRPC + FastAPI 应用

只需两条指令即可完成**构建 → 启动**：

```powershell
docker-compose build --no-cache   # 首次或源代码更新后
docker-compose up -d              # 后台启动全部服务
```

随后浏览器访问 `http://localhost:8000/docs` 查看自动生成的 API 文档。

> 如果你使用的是 **Docker Desktop**（Win/Mac），确保软件已启动且 WSL2/Hyper-V 已启用。

---

## 1. 环境准备

### 1.1 启动 Redis
> TIP：已使用 `docker-compose` 的同学可 **跳过** 本节，compose 会自动启动 redis 服务。

推荐用 Docker：
```powershell
docker run -d -p 6379:6379 redis
```
如无 Docker，可用 Redis for Windows 或 WSL。

### 1.2 安装依赖
```powershell
poetry install
poetry add redis
```

### 1.3 生成/更新 gRPC 代码
```powershell
python -m grpc_tools.protoc -I./proto --python_out=./app --grpc_python_out=./app ./proto/telemetry.proto
```

---

## 2. 启动服务

### 2.1 启动 gRPC 数据接收服务
```powershell
poetry run python -m app.ingest
```
- 看到 `INFO:root:🚚 gRPC ingest on :50051` 表示服务已启动。
- **不要关闭此窗口！**

### 2.2 启动 FastAPI Web 服务
另开新终端：
```powershell
poetry run uvicorn app.main:app --reload
```
- 看到 `Uvicorn running on http://127.0.0.1:8000` 表示服务已启动。
- **不要关闭此窗口！**

### 2.3 发送测试数据
再开新终端：
```powershell
poetry run python send_once.py
```
- 看到 `✅ Sent 10 packets` 表示数据已发送。

### 2.4 查看实时数据
浏览器访问：
```
http://localhost:8000/metrics
```
- 应返回：
```json
[
  {"device_id": "sensor-1", "count": 10}
]
```

---

## 3. 常见问题排查

### 3.1 Redis未启动/端口被占用
- 用 `docker ps` 检查容器状态。
- 用 `docker exec -it <容器ID> redis-cli` 进入容器，`ping` 应返回 `PONG`。

### 3.2 Python无法import redis
- 运行 `poetry add redis` 安装依赖。

### 3.3 gRPC代码未更新/找不到Ack
- 重新生成gRPC代码（见1.3）。

### 3.4 /metrics 为空
- 检查gRPC服务和FastAPI服务是否都在运行。
- 检查 send_once.py 是否有"Sent 10 packets"。
- 检查 Redis 是否有数据：
```powershell
docker exec -it <容器ID> redis-cli
127.0.0.1:6379> hgetall device_metrics
```

---

## 4. 工程意义说明
- **多进程/多服务解耦**：gRPC和FastAPI独立运行，互不影响。
- **Redis中间件**：实现跨进程/跨服务数据同步，是大厂分布式架构的事实标准。
- **gRPC流式传输**：高性能、跨语言，适合IoT/微服务。
- **FastAPI+自动文档**：现代API开发主流。
- **自动化测试/模拟数据**：send_once.py 便于开发和调试。

---

## 5. 进阶
- 支持多设备ID、并发测试、性能压测。
- 可扩展为Kafka/消息队列/数据库等大厂架构。
- 可加CI/CD、自动化部署等工程实践。

---

如有任何问题，把报错信息或终端输出发给我，我帮你一步步解决！ 